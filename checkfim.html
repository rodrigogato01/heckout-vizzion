<script>
    const API_URL = "https://checkout-pix-profissional.onrender.com"; 

    // Máscara CPF
    document.getElementById('cpf').addEventListener('input', e => {
        let v = e.target.value.replace(/\D/g,"");
        v = v.replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2");
        e.target.value = v;
    });

    async function gerarPixVizzion() {
        const nome = document.getElementById('nome').value;
        const email = document.getElementById('email').value;
        const cpf = document.getElementById('cpf').value.replace(/\D/g,'');
        const btn = document.getElementById('btnMain');

        if(nome.length < 3 || !email.includes('@') || cpf.length < 11) {
            return alert("Preencha todos os dados.");
        }

        btn.disabled = true;
        btn.innerText = "PROCESSANDO...";
        btn.style.opacity = "0.7";

        try {
            const response = await fetch(`${API_URL}/vizzion-pix`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: nome, email: email, cpf: cpf })
            });

            const data = await response.json();

            // SE OCORREU ERRO NA VIZZION
            if (!response.ok) {
                alert("ERRO DA VIZZION:\n" + JSON.stringify(data.detalhes || data.erro));
                console.error("Erro detalhado:", data);
                resetBtn();
                return;
            }

            // SUCESSO
            if (data.qr_code_base64 || data.pix_copy_paste || data.qr_imagem || data.qr_copia) {
                let img = data.qr_code_base64 || data.qr_imagem || data.qrcode;
                let code = data.pix_copy_paste || data.qr_copia;

                if (img && !img.startsWith('http')) img = `data:image/png;base64,${img}`;
                
                document.getElementById('qrImg').src = img;
                document.getElementById('pixCode').value = code;
                document.getElementById('pixModal').style.display = 'flex';
            } else {
                alert("Erro: API não retornou o QR Code.");
                console.log(data);
                resetBtn();
            }

        } catch (error) {
            alert("Erro de conexão com o servidor. Verifique se o servidor está online.");
            resetBtn();
        }
    }

    function resetBtn() {
        const btn = document.getElementById('btnMain');
        btn.disabled = false;
        btn.innerText = "FINALIZAR E RECEBER ACESSO";
        btn.style.opacity = "1";
    }

    function copyPix() {
        const txt = document.getElementById('pixCode');
        txt.select();
        document.execCommand('copy');
        alert("Copiado!");
    }
</script>