<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Pix Autom√°tico</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; background-color: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        h2 { color: #333; }
        button { background-color: #009EE3; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 5px; cursor: pointer; margin-top: 20px; width: 100%; }
        button:hover { background-color: #007bb0; }
        #qr-container { margin-top: 20px; display: none; }
        #status { margin-top: 15px; font-weight: bold; color: #555; }
        img { max-width: 100%; border: 1px solid #ddd; border-radius: 5px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #009EE3; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="card">
        <h2>Teste de Velocidade Pix ‚ö°</h2>
        <p>Fa√ßa um Pix de <b>R$ 0,01</b> e receba o estorno em segundos.</p>
        
        <button onclick="gerarPix()" id="btn-pagar">Gerar QR Code (R$ 0,01)</button>
        
        <div class="loader" id="loader"></div>
        
        <div id="qr-container">
            <p>Escaneie para pagar:</p>
            <img id="qr-image" src="" alt="QR Code Pix" />
            <br><br>
            <textarea id="copia-cola" rows="4" style="width: 100%; font-size: 12px;" readonly></textarea>
            <p id="status">Aguardando pagamento...</p>
        </div>
    </div>

    <script>
        // SEU LINK DA RENDER EST√Å AQUI üëá
        const API_URL = "https://checkout-pix-profissional.onrender.com"; 

        async function gerarPix() {
            const btn = document.getElementById('btn-pagar');
            const loader = document.getElementById('loader');
            const container = document.getElementById('qr-container');
            const statusText = document.getElementById('status');

            btn.disabled = true;
            btn.innerText = "Gerando...";
            loader.style.display = "block";
            container.style.display = "none";

            try {
                // 1. CHAMA O SEU SERVIDOR NA RENDER
                const response = await fetch(`${API_URL}/pix`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: 0.01, // Valor do teste
                        name: "Teste Cliente",
                        cpf: "12345678900" // CPF gen√©rico para teste
                    })
                });

                const data = await response.json();

                if (data.point_of_interaction) {
                    // 2. EXIBE O QR CODE
                    const qrCodeBase64 = data.point_of_interaction.transaction_data.qr_code_base64;
                    const copiaCola = data.point_of_interaction.transaction_data.qr_code;
                    const idPagamento = data.id;

                    document.getElementById('qr-image').src = `data:image/png;base64,${qrCodeBase64}`;
                    document.getElementById('copia-cola').value = copiaCola;
                    
                    loader.style.display = "none";
                    container.style.display = "block";
                    btn.innerText = "Gerar Novo Pix";
                    btn.disabled = false;

                    // 3. COME√áA A VERIFICAR SE PAGOU (POLLING)
                    verificarStatus(idPagamento);
                } else {
                    alert('Erro ao gerar Pix: ' + JSON.stringify(data));
                    btn.disabled = false;
                    loader.style.display = "none";
                }

            } catch (error) {
                console.error(error);
                alert('Erro de conex√£o! Veja se o servidor na Render est√° LIVE.');
                btn.disabled = false;
                btn.innerText = "Tentar Novamente";
                loader.style.display = "none";
            }
        }

        async function verificarStatus(id) {
            const statusText = document.getElementById('status');
            
            // Verifica a cada 3 segundos
            const intervalo = setInterval(async () => {
                try {
                    const res = await fetch(`${API_URL}/pix/${id}`);
                    const json = await res.json();

                    if (json.status === 'approved') {
                        statusText.innerHTML = "‚úÖ <b>PAGAMENTO APROVADO!</b><br>O estorno deve chegar em breve.";
                        statusText.style.color = "green";
                        clearInterval(intervalo); // Para de verificar
                    }
                } catch (e) {
                    console.log("Verificando...");
                }
            }, 3000);
        }
    </script>
</body>
</html>